<!doctype html>
<html>
<head>
    <title>Session</title>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
    <h3>Name: {{ name }}</h3>
    <div id="app">
        {% raw %}
        <p>{{ message }}</p>
        <li v-for="(item, index) in items" v-if="!item.reviewed">
            <input type="checkbox" v-model="item.reviewed">
            <span v-if=item.displayWord>{{ item.word }}</span>
            <span v-else=item.displayWord v-on:click="displayWord(index)">Display Word</span>
            <span>{{ item.firstPart }}</span>
            <input v-model="item.input" v-on:keyup.enter="submit(index)">
            <span>{{ item.secondPart }}</span>
            <span>{{ item.result }}</span>
        </li>
        <div>
            <button v-on:click="createOrSubmitSession">{{next_mode_text}}</button>
        </div>
        {% endraw %}
    </div>
    <script>
    function getDefaultItem() {
        return {
            word: '',
            sentence: '',
            firstPart: '',
            secondPart: '',
            displayWord: false,
            input: '',
            result: undefined,
            reviewed: false,
        };
    }
    function processItems(items) {
        var itmesProcessed = [];
        for (var i in items) {
            var newItem = items[i];
            var startPos = newItem.sentence.indexOf(newItem.word);
            newItem.firstPart = newItem.sentence.substring(0, startPos);
            newItem.secondPart = newItem.sentence.substring(startPos + newItem.word.length);
            itmesProcessed.push(newItem);
        }
        return itmesProcessed;
    }
    function getItemsFromJson(json) {
        var items = []
        var session = JSON.parse(json);
        for (var i in session.words) {
            for (var j in session.words[i].notes) {
                var note = session.words[i].notes[j];
                var item = getDefaultItem(); 
                item.word = note.word;
                item.sentence = note.sentence; 
            }
            items.push(item);
        }
        return items;
    }
    var app = new Vue({
        el: '#app',
        data: {
            message: 'Hello Vue.js!',
            items: [],
            inputs: [],
            next_mode_text: 'New Session',
            curr_mode: 'done',
        },
        methods: {
            submit: function(index) {
                this.items[index].result = (this.items[index].input == this.items[index].word);
            },
            displayWord: function(index) {
                this.items[index].displayWord = true;
            },
            createOrSubmitSession: function() {
                if (this.curr_mode == 'in-progress') {
                    this.curr_mode = 'done';
                    this.items = [];
                    this.next_mode_text = 'New Session';
                } else {
                    this.curr_mode = 'in-progress';
                    this.next_mode_text = 'Done';
                    // return;
                    $.ajax({
                        // TODO: Make it configurable.
                        url: "http://localhost:5000/sessions/1",
                        type: 'GET',
                        success: function(response) {
                            console.log("success:", response);
                            app.items = processItems(getItemsFromJson(response));
                        },
                        error: function(result) {
                            console.log(result)
                        }
                    });
                }
            },
        }
    })
    </script>
</body>
</html>
